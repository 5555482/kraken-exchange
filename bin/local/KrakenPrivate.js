// Generated by CoffeeScript 1.12.5
(function() {
  var Crypto, KrakenAPI, KrakenPrivate, NONCE, Querystring, sign,
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  KrakenAPI = require('./KrakenAPI');

  Querystring = require('querystring');

  Crypto = require('crypto');

  NONCE = new Date().valueOf() * 1000;

  sign = function(path, secret, params) {
    var hash, hash_digest, hmac, hmac_digest, message;
    message = Querystring.stringify(params);
    secret = Buffer.from(secret, 'base64');
    hash = Crypto.createHash('sha256');
    hmac = Crypto.createHmac('sha512', secret);
    hash_digest = hash.update(params.nonce + message).digest('latin1');
    return hmac_digest = hmac.update(path + hash_digest, 'latin1').digest('base64');
  };

  KrakenPrivate = (function(superClass) {
    extend(KrakenPrivate, superClass);

    function KrakenPrivate(method, key, secret, params) {
      var headers, path;
      if (params == null) {
        params = {};
      }
      headers = {
        'API-KEY': key
      };
      path = "private/" + method;
      KrakenPrivate.__super__.constructor.call(this, path, headers, params);
      this.key = key;
      this.secret = secret;
    }

    KrakenPrivate.prototype.api = function() {
      var path, sig;
      this.form.nonce = NONCE++;
      path = this.url.pathname;
      sig = sign(path, this.secret, this.form);
      this.headers['API-Sign'] = sig;
      return KrakenPrivate.__super__.api.call(this);
    };

    return KrakenPrivate;

  })(KrakenAPI);

  module.exports = KrakenPrivate;

}).call(this);
